<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¼per TÄ±klama Oyunu (Online YarÄ±ÅŸma)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
        }
        /* TÄ±klama Butonuna Ã–zel Stil */
        #clickButton {
            transition: all 0.1s ease;
            box-shadow: 0 6px #0d47a1; 
            position: relative; 
        }
        #clickButton:active {
            box-shadow: 0 0 #0d47a1;
            transform: translateY(6px);
        }
        /* KaydÄ±rma Ã§ubuÄŸu stili */
        #marketItems, #rebirthStoreItems, #leaderboard {
            max-height: 500px;
            overflow-y: auto;
        }
        .view-container {
            min-height: 550px; 
        }
        .nav-btn.active {
            background-color: #f59e0b; 
            color: #1f2937;
        }
        #navRebirthStore.active {
            background-color: #a78bfa; 
            color: #1f2937;
        }
        #navCompetition.active {
            background-color: #ef4444; 
            color: #1f2937;
        }
        /* Pasif buton stili (YarÄ±ÅŸma sÄ±rasÄ±nda) */
        .nav-btn:disabled, .nav-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        /* TÄ±klama Pop-up Animasyonu */
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        .click-popup {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #34d399; /* YeÅŸil tonu */
            pointer-events: none;
            user-select: none;
            animation: floatUp 1s ease-out forwards;
            white-space: nowrap;
        }
        
        #competitionButton {
            transition: background-color 0.2s;
        }
        #competitionButton:disabled {
            background-color: #4b5563; /* Gri renk */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-white min-h-screen flex items-center justify-center p-4">

    <!-- Ana Oyun Konteyneri -->
    <div class="w-full max-w-4xl bg-gray-800 rounded-xl shadow-2xl p-6">
        <h1 class="text-4xl font-extrabold text-center mb-6 text-blue-400">THE CLICKER: Online Rekabet</h1>

        <!-- Durum Bilgileri (Ãœst Panel) -->
        <div class="grid grid-cols-2 gap-4 p-4 mb-4 bg-gray-900 rounded-lg border border-gray-700">
            <!-- Para -->
            <div class="col-span-1">
                <p class="text-base">ğŸ’° Para:</p>
                <span id="coinDisplay" class="font-bold text-yellow-400 text-3xl block">0</span>
            </div>
            <!-- Rebirth -->
            <div class="col-span-1">
                <p class="text-base">ğŸŒŸ Rebirth:</p>
                <span id="rebirthDisplay" class="font-bold text-indigo-400 text-3xl block">0</span>
            </div>
            <!-- RBP -->
            <div class="col-span-1">
                <p class="text-base text-purple-300">âš›ï¸ RBP (Puan):</p>
                <span id="rbpDisplay" class="font-semibold text-purple-400 text-2xl block">0</span>
            </div>
             <!-- SBK (Net) -->
            <div class="col-span-1">
                <p class="text-base text-red-300">âš™ï¸ Pasif (SBK):</p>
                <span id="passiveRateDisplay" class="font-semibold text-red-400 text-2xl block">0</span>
            </div>
             <!-- TBK Display -->
            <div class="col-span-2">
                <p class="text-base text-green-300">âœ¨ TÄ±klama (TBK):</p>
                <span id="clickValueDisplay" class="font-semibold text-green-400 text-2xl block">1</span>
            </div>
            <!-- Autoclicker Durumu -->
            <div class="col-span-2 text-center">
                <p class="text-sm text-gray-400">âš¡ Otomatik TÄ±klama HÄ±zÄ±:</p>
                <span id="autoclickerDisplay" class="font-semibold text-blue-300 text-xl block">0 / sn</span>
            </div>
        </div>

        <!-- Gezinme (Navigation) -->
        <nav class="flex justify-center flex-wrap gap-4 mb-6">
            <button id="navClicker" class="nav-btn active px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-bold transition duration-150">TÄ±klama Merkezi</button>
            <button id="navMarket" class="nav-btn px-4 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700 font-bold transition duration-150">Pazar (Para)</button>
            <button id="navRebirthStore" class="nav-btn px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 font-bold transition duration-150">RBP MaÄŸazasÄ±</button>
            <button id="navCompetition" class="nav-btn px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 font-bold transition duration-150">ğŸ’¥ Online YarÄ±ÅŸma</button>
        </nav>

        <!-- GÃ¶rÃ¼nÃ¼m Konteynerleri -->
        
        <!-- 1. TÄ±klama Merkezi GÃ¶rÃ¼nÃ¼mÃ¼ -->
        <div id="clickerView" class="view-container">
            <div class="p-6 bg-gray-700 rounded-xl shadow-inner border border-blue-500">
                <h2 class="text-3xl font-bold mb-6 text-blue-300 text-center">TÄ±kla ve Kazan!</h2>
                
                <!-- TÄ±klama Butonu (Pop-up'lar iÃ§in gerekli alan) -->
                <div id="clickerArea" class="relative w-full h-40">
                    <button id="clickButton" 
                            class="w-full h-full bg-blue-600 hover:bg-blue-700 text-white font-extrabold text-5xl rounded-lg border-b-6 border-blue-800 active:border-b-4 transition-all duration-75">
                        TIKLA!
                    </button>
                </div>


                <!-- Rebirth AlanÄ± -->
                <div class="mt-8 p-4 bg-purple-900 rounded-lg border-2 border-purple-500 text-center">
                    <h3 class="text-2xl font-bold text-purple-300 mb-2">Yeniden DoÄŸuÅŸ (Rebirth)</h3>
                    <p class="text-sm text-gray-300 mb-3">TÃ¼m ilerlemenizi sÄ±fÄ±rlayÄ±n, ancak kalÄ±cÄ± bir Ã§arpan ve RBP kazanÄ±n. (Gereksinim: 100 Net SBK)</p>
                    <button id="rebirthButton" 
                            class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg rounded-full shadow-lg transition duration-150">
                        YENÄ°DEN DOÄ
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Para Market GÃ¶rÃ¼nÃ¼mÃ¼ -->
        <div id="marketView" class="view-container hidden">
            <div class="p-6 bg-gray-700 rounded-xl shadow-inner border border-yellow-500">
                <h2 class="text-3xl font-bold mb-6 text-yellow-300 text-center">Pazar (Para YÃ¼kseltmeleri)</h2>
                <p class="text-sm text-gray-300 mb-4 text-center">ParalarÄ±nÄ±zÄ± harcayarak TÄ±klama veya Pasif gelirinizi kalÄ±cÄ± olarak artÄ±rÄ±n.</p>
                
                <div id="marketItems" class="space-y-4">
                    <!-- Market KartlarÄ± Buraya JS ile Eklenecek -->
                </div>
            </div>
        </div>

        <!-- 3. Rebirth PuanÄ± MaÄŸazasÄ± GÃ¶rÃ¼nÃ¼mÃ¼ -->
        <div id="rebirthStoreView" class="view-container hidden">
            <div class="p-6 bg-gray-700 rounded-xl shadow-inner border border-purple-500">
                <h2 class="text-3xl font-bold mb-6 text-purple-300 text-center">Yeniden DoÄŸuÅŸ MaÄŸazasÄ± (RBP)</h2>
                <p class="text-sm text-gray-300 mb-4 text-center">RBP puanlarÄ±nÄ±zÄ± harcayarak oyun boyunca kalÄ±cÄ± olarak etkili olacak yÃ¼kseltmeler alÄ±n.</p>
                
                <div id="rebirthStoreItems" class="space-y-4">
                    <!-- RBP MaÄŸazasÄ± KartlarÄ± Buraya JS ile Eklenecek -->
                </div>
            </div>
        </div>
        
        <!-- 4. Online YarÄ±ÅŸma GÃ¶rÃ¼nÃ¼mÃ¼ (YENÄ°) -->
        <div id="competitionView" class="view-container hidden">
            <div class="p-6 bg-gray-700 rounded-xl shadow-inner border border-red-500">
                <h2 class="text-3xl font-bold mb-6 text-red-300 text-center">CANLI TIKLAMA DÃœELLOSU (1v1)</h2>
                
                <!-- Geri SayÄ±m SayacÄ± -->
                <div id="timerDisplay" class="p-4 mb-4 bg-red-900 rounded-lg text-center font-extrabold text-4xl border-2 border-red-500">
                    SÃ¼re: HazÄ±r
                </div>

                <!-- YarÄ±ÅŸma TÄ±klama AlanÄ± -->
                <div id="competitionClickerArea" class="relative w-full h-40">
                    <button id="competitionButton"
                            class="w-full h-full bg-green-600 hover:bg-green-700 text-white font-extrabold text-3xl rounded-lg transition-all duration-75">
                        YARIÅMAYA BAÅLA
                    </button>
                </div>

                <div id="myScoreDisplay" class="mt-4 p-3 bg-red-900 rounded-lg text-center font-bold text-xl border border-red-500">
                    Sizin TÄ±klamanÄ±z: 0
                </div>
                
                <h3 class="text-xl font-bold text-red-300 mt-6 mb-3 text-center">Liderlik Tablosu</h3>
                <div id="leaderboard" class="space-y-2 bg-gray-800 p-4 rounded-lg">
                    <p class="text-center text-gray-400">Liderlik Tablosu YÃ¼kleniyor...</p>
                </div>
                
            </div>
        </div>


        <!-- Mesaj Kutusu -->
        <div id="messageBox" class="fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-3 bg-red-600 text-white font-bold rounded-lg shadow-xl hidden transition duration-300 ease-in-out">
            Yeterli paranÄ±z yok!
        </div>

        <!-- KullanÄ±cÄ± KimliÄŸi Bilgisi (Firestore gereÄŸi zorunlu) -->
        <div class="mt-6 p-2 text-xs text-gray-500 text-center bg-gray-900 rounded-lg">
            KullanÄ±cÄ± KimliÄŸiniz (DiÄŸer oyuncular iÃ§in): <span id="currentUserId" class="font-mono text-gray-300 break-all">YÃ¼kleniyor...</span>
        </div>

    </div>

    <!-- JavaScript Oyun ve Firebase MantÄ±ÄŸÄ± -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, increment, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore AyarlarÄ± ve DeÄŸiÅŸkenleri
        let db;
        let auth;
        let userId = null;
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-clicker-app';
        
        // YapÄ±landÄ±rmayÄ± daha gÃ¼venli bir ÅŸekilde yÃ¼kleme
        let FIREBASE_CONFIG = {};
        let IS_FIREBASE_ENABLED = false;
        const initialConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        if (initialConfigString && initialConfigString.trim() !== "") {
            try {
                FIREBASE_CONFIG = JSON.parse(initialConfigString);
                // YapÄ±landÄ±rma baÅŸarÄ±lÄ±ysa Firebase'i etkinleÅŸtir
                if (FIREBASE_CONFIG && FIREBASE_CONFIG.projectId) {
                    IS_FIREBASE_ENABLED = true;
                }
            } catch (e) {
                console.error("Firebase yapÄ±landÄ±rmasÄ± JSON ayrÄ±ÅŸtÄ±rma hatasÄ±:", e);
                // Hata oluÅŸsa bile IS_FIREBASE_ENABLED false kalacak.
            }
        }
        
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore Koleksiyon YollarÄ± (Genel Veri - Public)
        const RACE_SCORES_PATH = `artifacts/${APP_ID}/public/data/race_scores`;
        const RACE_QUEUE_PATH = `artifacts/${APP_ID}/public/data/race_queue`; 
        
        // Local Game State
        let coins = 0;             
        let baseClickValue = 1;    
        let basePassiveRate = 0;   
        let rebirths = 0;          
        let rebirthMultiplier = 1; 
        let passiveMultiplier = 1; 
        let rebirthPoints = 0;     
        let rbpStartingCoinBonus = 0; 
        let rbpPassiveSpeedBonus = 1; 
        let rbpAutoclickerLevel = 0;  
        let lastSaveTime = Date.now();
        const MAX_OFFLINE_TIME_SECONDS = 8 * 60 * 60;

        // Firebase YarÄ±ÅŸma Durumu (YENÄ° EKLEMELER)
        let competitionActive = false;
        let competitionStartTime = 0;
        let competitionTimer = null;
        const COMPETITION_DURATION_SECONDS = 45; // 45 Saniye
        let currentRaceClicks = 0; // Bu yarÄ±ÅŸmada kullanÄ±cÄ±nÄ±n yaptÄ±ÄŸÄ± tÄ±klama sayÄ±sÄ±
        
        // EÅŸleÅŸtirme DurumlarÄ±
        let matchmakingStatus = 'idle'; // 'idle', 'in_queue', 'in_match'
        let opponentId = null;
        let randomOpponentDisplayId = null; // 3+ kiÅŸi olduÄŸunda rastgele gÃ¶sterilen rakip
        
        // HTML Elementleri
        const coinDisplay = document.getElementById('coinDisplay');
        const rebirthDisplay = document.getElementById('rebirthDisplay');
        const rbpDisplay = document.getElementById('rbpDisplay'); 
        const clickValueDisplay = document.getElementById('clickValueDisplay');
        const passiveRateDisplay = document.getElementById('passiveRateDisplay');
        const autoclickerDisplay = document.getElementById('autoclickerDisplay'); 
        const clickButton = document.getElementById('clickButton');
        const marketItemsContainer = document.getElementById('marketItems');
        const rebirthStoreItemsContainer = document.getElementById('rebirthStoreItems'); 
        const messageBox = document.getElementById('messageBox');
        const currentUserIdDisplay = document.getElementById('currentUserId');
        const leaderboardContainer = document.getElementById('leaderboard');
        const myScoreDisplay = document.getElementById('myScoreDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const competitionButton = document.getElementById('competitionButton');
        const clickerArea = document.getElementById('clickerArea');
        const navClicker = document.getElementById('navClicker');
        const navMarket = document.getElementById('navMarket');
        const navRebirthStore = document.getElementById('navRebirthStore');
        const navCompetition = document.getElementById('navCompetition');
        const navButtons = [navClicker, navMarket, navRebirthStore, navCompetition];
        const rebirthButton = document.getElementById('rebirthButton'); 

        // Pazar Ã–ÄŸeleri Verisi (KÄ±saltÄ±ldÄ±)
        const MARKET_ITEMS = [
            { id: 1, name: "GeliÅŸmiÅŸ Parmak", cost: 10, initialCost: 10, multiplier: 1.5, type: 'click', value: 1, level: 0, maxLevel: 50, description: "TÄ±klama baÅŸÄ±na kazancÄ± 1 artÄ±rÄ±r." },
            { id: 2, name: "Otomatik TÄ±klayÄ±cÄ±", cost: 100, initialCost: 100, multiplier: 1.15, type: 'passive', value: 1, level: 0, maxLevel: 100, description: "Saniye baÅŸÄ±na 1 pasif gelir saÄŸlar." },
            { id: 4, name: "Ä°ÅŸ Merkezi", cost: 5000, initialCost: 5000, multiplier: 1.3, type: 'passive', value: 50, level: 0, maxLevel: 10, description: "Saniye baÅŸÄ±na 50 pasif gelir saÄŸlar." }
        ];

        // RBP MaÄŸazasÄ± Ã–ÄŸeleri Verisi (KÄ±saltÄ±ldÄ±)
        const REBIRTH_ITEMS = [
            { id: 101, name: "BaÅŸlangÄ±Ã§ ParasÄ±", cost: 5, initialCost: 5, multiplier: 1.5, type: 'starting_coin', value: 10, level: 0, maxLevel: 10, description: "Her Rebirth sonrasÄ± 10 fazladan para ile baÅŸlar." },
            { id: 103, name: "Otomatik TÄ±klama", cost: 50, initialCost: 50, multiplier: 2.5, type: 'autoclick', value: 1, level: 0, maxLevel: 10, description: "Saniyede 1 Otomatik TÄ±klama ekler. (KalÄ±cÄ±)" }
        ];


        // ------------------------------------------------------------------
        // YARDIMCI VE UI FONKSÄ°YONLARI
        // ------------------------------------------------------------------

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + " M";
            }
            return Math.floor(num).toLocaleString('tr-TR');
        }
        
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            // TÃ¼m bg sÄ±nÄ±flarÄ±nÄ± temizle
            messageBox.className = messageBox.className.replace(/\sbg-(red|green|purple|blue|gray)-\d+/g, '');
            
            if (type === 'error') messageBox.classList.add('bg-red-600');
            else if (type === 'success') messageBox.classList.add('bg-green-600');
            else if (type === 'info') messageBox.classList.add('bg-purple-600');
            else if (type === 'offline') messageBox.classList.add('bg-blue-600');
            else if (type === 'leave') messageBox.classList.add('bg-red-600'); // KÄ±rmÄ±zÄ± arka plan
            
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); 
        }

        function toggleNavButtons(disabled) {
            // YarÄ±ÅŸma aktifken (disabled=true), navCompetition hariÃ§ tÃ¼m butonlarÄ± devre dÄ±ÅŸÄ± bÄ±rak
            navButtons.forEach(btn => {
                if (btn.id !== 'navCompetition') {
                    btn.disabled = disabled;
                }
            });
            // Nav Competition butonu her zaman aktif kalÄ±r, yarÄ±ÅŸma butonu kendi durumunu yÃ¶netir.
            if (disabled) {
                // Kilitli butonlarÄ±n renklerini de gri yap
                 navClicker.classList.replace('bg-blue-600', 'bg-gray-600');
                 navMarket.classList.replace('bg-yellow-600', 'bg-gray-600');
                 navRebirthStore.classList.replace('bg-purple-600', 'bg-gray-600');
                 navClicker.classList.remove('hover:bg-blue-700');
                 navMarket.classList.remove('hover:bg-yellow-700');
                 navRebirthStore.classList.remove('hover:bg-purple-700');
            } else {
                // Kilit aÃ§Ä±kken renkleri geri getir
                navClicker.classList.replace('bg-gray-600', 'bg-blue-600');
                navMarket.classList.replace('bg-gray-600', 'bg-yellow-600');
                navRebirthStore.classList.replace('bg-gray-600', 'bg-purple-600');
                navClicker.classList.add('hover:bg-blue-700');
                navMarket.classList.add('hover:bg-yellow-700');
                navRebirthStore.classList.add('hover:bg-purple-700');
            }
        }

        function switchView(viewId) {
            
            // YENÄ° KONTROL: EÄŸer yarÄ±ÅŸma aktif ve kullanÄ±cÄ± yarÄ±ÅŸma gÃ¶rÃ¼nÃ¼mÃ¼nden Ã§Ä±kmaya Ã§alÄ±ÅŸÄ±yorsa engelle
            if (competitionActive && viewId !== 'competitionView') {
                showMessage("YarÄ±ÅŸma aktifken diÄŸer sayfalara geÃ§emezsiniz. LÃ¼tfen yarÄ±ÅŸmanÄ±n bitmesini bekleyin.", 'error');
                return; 
            }

            const wasInQueue = matchmakingStatus === 'in_queue';
            const isCompetitionView = viewId === 'competitionView';

            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId)?.classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const navBase = viewId.replace('View', '');
            const navId = 'nav' + navBase.charAt(0).toUpperCase() + navBase.slice(1);
            document.getElementById(navId)?.classList.add('active');
            
            if (viewId === 'marketView') renderMarket(MARKET_ITEMS, marketItemsContainer, buyItem, coins, 'ğŸ’°');
            if (viewId === 'rebirthStoreView') renderMarket(REBIRTH_ITEMS, rebirthStoreItemsContainer, buyRebirthItem, rebirthPoints, 'âš›ï¸');
            
            if (isCompetitionView) {
                if (IS_FIREBASE_ENABLED) {
                    joinQueue();
                } else {
                    // Firebase etkin deÄŸilse, yarÄ±ÅŸma butonunu devre dÄ±ÅŸÄ± bÄ±rak
                    timerDisplay.textContent = `Ã‡evrimdÄ±ÅŸÄ± Modda Aktif DeÄŸil`;
                    competitionButton.textContent = "Ã‡evrimiÃ§i DeÄŸil";
                    competitionButton.disabled = true;
                }
            } else {
                // DiÄŸer gÃ¶rÃ¼nÃ¼mlere geÃ§ildiÄŸinde kuyruktan Ã§Ä±k
                leaveQueue(wasInQueue); 
                endCompetition(true); // Gerekirse yarÄ±ÅŸmayÄ± durdur
            }
        }
        
        // ------------------------------------------------------------------
        // FIREBASE Ä°ÅLEMLERÄ°
        // ------------------------------------------------------------------

        async function initializeFirebase() {
            if (!IS_FIREBASE_ENABLED) {
                console.warn("Firebase yapÄ±landÄ±rmasÄ± eksik. Ã‡evrimiÃ§i Ã¶zellikler devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±.");
                currentUserIdDisplay.textContent = "ğŸ”´ Ã‡EVRÄ°MDÄ°SÄ° MOD";
                // Ã‡evrimdÄ±ÅŸÄ± modda bile yarÄ±ÅŸma sekmesine tÄ±klandÄ±ÄŸÄ±nda uyarÄ± ver
                document.getElementById('navCompetition').addEventListener('click', () => {
                     if (!IS_FIREBASE_ENABLED) {
                         showMessage("Online YarÄ±ÅŸma, Firebase yapÄ±landÄ±rmasÄ± gerektirir.", 'error');
                     }
                });
                return;
            }
            
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);

                if (INITIAL_AUTH_TOKEN) {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdDisplay.textContent = userId;
                        loadCompetitionScore();
                        startLeaderboardListener();
                        startMatchmakingListener(); 
                    } else {
                        userId = null;
                        currentUserIdDisplay.textContent = "GiriÅŸ YapÄ±lmadÄ±";
                    }
                });
                
            } catch (error) {
                console.error("Firebase baÅŸlatÄ±lÄ±rken hata oluÅŸtu:", error);
                currentUserIdDisplay.textContent = "ğŸ”´ HATA! (Bkz. Konsol)";
            }
        }

        // --- YarÄ±ÅŸma Skoru YÃ¶netimi ---

        async function loadCompetitionScore() {
             if (!userId || !db) return;
             const userRaceDocRef = doc(db, RACE_SCORES_PATH, userId);
             try {
                // Skoru 0 ile baÅŸlat
                await setDoc(userRaceDocRef, {
                    userId: userId,
                    clicks: 0,
                    lastUpdate: Date.now()
                }, { merge: true });
                currentRaceClicks = 0; 
                updateCompetitionDisplay();
             } catch (error) {
                console.error("YarÄ±ÅŸma skoru yÃ¼klenirken/ayarlanÄ±rken hata oluÅŸtu:", error);
             }
        }
        
        async function updateCompetitionScore() {
            if (!userId || !db || !competitionActive) return;

            const userRaceDocRef = doc(db, RACE_SCORES_PATH, userId);

            try {
                // TÄ±klama sayÄ±sÄ±nÄ± 1 artÄ±r
                await updateDoc(userRaceDocRef, {
                    clicks: increment(1),
                    lastUpdate: Date.now()
                });
            } catch (error) {
                console.error("YarÄ±ÅŸma skoru gÃ¼ncellenirken hata oluÅŸtu:", error);
            }
        }
        
        // --- Liderlik Tablosu Dinleyicisi ---

        function startLeaderboardListener() {
            if (!db) return;
            const q = collection(db, RACE_SCORES_PATH); 
            
            onSnapshot(q, (snapshot) => {
                let scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });
                
                scores.sort((a, b) => b.clicks - a.clicks); 
                renderLeaderboard(scores);
            }, (error) => {
                console.error("Liderlik tablosu dinlenirken hata:", error);
                leaderboardContainer.innerHTML = `<p class="text-center text-red-400">Hata: Liderlik tablosu yÃ¼klenemedi.</p>`;
            });
        }
        
        function renderLeaderboard(scores) {
            leaderboardContainer.innerHTML = '';
            
            let myRank = -1;
            let myClicks = 0;

            scores.forEach((score, index) => {
                const rank = index + 1;
                const isMe = score.userId === userId;
                
                if (isMe) {
                    myRank = rank;
                    myClicks = score.clicks;
                    currentRaceClicks = score.clicks; 
                }

                const opponentName = score.userId === opponentId ? 'RAKÄ°BÄ°NÄ°Z' : isMe ? 'SÄ°Z' : score.userId.substring(0, 8) + '...';
                const rankColor = rank === 1 ? 'text-yellow-400' : rank === 2 ? 'text-gray-300' : rank === 3 ? 'text-orange-400' : 'text-white';
                const bgColor = isMe ? 'bg-red-700 border-red-400' : score.userId === opponentId ? 'bg-purple-700 border-purple-400' : 'bg-gray-600 border-gray-700';

                const itemHtml = `
                    <div class="p-3 flex items-center justify-between rounded-lg font-mono border ${bgColor}">
                        <span class="font-bold ${rankColor}">${rank}.</span>
                        <span class="truncate ml-4 flex-1 text-sm">${opponentName}</span>
                        <span class="text-lg font-extrabold text-right">${formatNumber(score.clicks)} TÄ±k</span>
                    </div>
                `;
                leaderboardContainer.innerHTML += itemHtml;
            });
            
            updateCompetitionDisplay(myRank, myClicks);
        }

        // --- EÅŸleÅŸtirme KuyruÄŸu YÃ¶netimi ---
        
        async function joinQueue() {
            // Firebase aktif deÄŸilse veya zaten kuyruktaysam/maÃ§taysam iÅŸlem yapma
            if (!userId || !db || matchmakingStatus !== 'idle') return;
            matchmakingStatus = 'in_queue';
            
            const userQueueDocRef = doc(db, RACE_QUEUE_PATH, userId);
            try {
                await setDoc(userQueueDocRef, {
                    userId: userId,
                    status: 'in_queue',
                    timestamp: Date.now(),
                    opponentId: null 
                });
                showMessage("EÅŸleÅŸtirme kuyruÄŸuna katÄ±ldÄ±nÄ±z. Rakip bekleniyor...", 'info');
                updateCompetitionUI(); 
            } catch (error) {
                console.error("KuyruÄŸa katÄ±lÄ±rken hata:", error);
                matchmakingStatus = 'idle';
            }
        }
        
        async function leaveQueue(wasInQueueBeforeLeaving = false) {
            if (!userId || !db || matchmakingStatus === 'idle') return;
            
            const currentStatus = matchmakingStatus; 
            matchmakingStatus = 'idle';
            opponentId = null;
            
            const userQueueDocRef = doc(db, RACE_QUEUE_PATH, userId);
            try {
                // Silme iÅŸlemine hata oluÅŸursa (belge yoksa) sadece uyarÄ± verip devam et.
                await deleteDoc(userQueueDocRef);
            } catch (error) {
                 console.warn("Kuyruktan Ã§Ä±karken (doc silinirken) hata:", error);
            }
            
            // EÄŸer eÅŸleÅŸme aranÄ±rken Ã§Ä±kÄ±ldÄ±ysa, Ã¶zel mesajÄ± gÃ¶ster
            if (currentStatus === 'in_queue' && wasInQueueBeforeLeaving) {
                showMessage("YarÄ±ÅŸtan AyrÄ±ldÄ±n", 'leave'); // KÄ±rmÄ±zÄ± arka planlÄ± mesaj
            }
            
            updateCompetitionUI();
        }

        function startMatchmakingListener() {
            // Sadece Firebase aktifse dinlemeye baÅŸlarÄ±z
            if (!db) return;
            const q = collection(db, RACE_QUEUE_PATH); 
            
            onSnapshot(q, (snapshot) => {
                if (document.getElementById('competitionView').classList.contains('hidden') && !competitionActive) {
                    // KullanÄ±cÄ± YarÄ±ÅŸma GÃ¶rÃ¼nÃ¼mÃ¼nde deÄŸil ve aktif bir yarÄ±ÅŸma yoksa, eÅŸleÅŸtirme yapma
                    return; 
                }
                
                let queueUsers = [];
                let myQueueDoc = null;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId === userId) {
                        myQueueDoc = data;
                    } else {
                        // DiÄŸer kullanÄ±cÄ±larÄ± kuyruÄŸa ekle (kendisi hariÃ§)
                        queueUsers.push(data);
                    }
                });

                checkMatchmaking(myQueueDoc, queueUsers);
                updateCompetitionUI(queueUsers);

            }, (error) => {
                console.error("EÅŸleÅŸtirme dinlenirken hata:", error);
            });
        }
        
        async function checkMatchmaking(myQueueDoc, queueUsers) {
            if (!userId) return;

            // 1. Durum: EÅŸleÅŸmede miyim? (Rakip tarafÄ±ndan ayarlandÄ± veya ben ayarladÄ±m)
            if (myQueueDoc && myQueueDoc.status === 'in_match' && myQueueDoc.opponentId) {
                matchmakingStatus = 'in_match';
                opponentId = myQueueDoc.opponentId;
                if (!competitionActive) {
                    startCompetition(opponentId); 
                }
                return;
            }
            
            // 2. Durum: Kuyrukta mÄ±yÄ±m? (EÅŸleÅŸme arÄ±yorum)
            if (myQueueDoc && myQueueDoc.status === 'in_queue') {
                matchmakingStatus = 'in_queue';
                
                // MÃ¼sait olan rakipler (sadece 'in_queue' durumundakiler)
                const availableOpponents = queueUsers.filter(u => u.status === 'in_queue');
                
                // 3+ KiÅŸi KuralÄ±: Toplam aktif kullanÄ±cÄ± sayÄ±sÄ± (ben dahil) 3 veya daha fazlaysa
                if (queueUsers.length >= 2) { 
                    // 3+ aktif kiÅŸi var. Rastgele birini rakip gibi gÃ¶ster ve bekleme durumunu koru.
                    const allActiveIds = queueUsers.map(u => u.userId);
                    randomOpponentDisplayId = allActiveIds[Math.floor(Math.random() * allActiveIds.length)];
                } else {
                    randomOpponentDisplayId = null;
                }
                
                // EÅŸleÅŸtirme GiriÅŸimi (Client-Side Race)
                if (availableOpponents.length > 0) {
                     // Kuyruktaki en eski benim miyim? Ben baÅŸlatmalÄ±yÄ±m.
                     // (Ben + diÄŸer mÃ¼sait rakipler)
                     const allQueue = [...availableOpponents, myQueueDoc].sort((a, b) => a.timestamp - b.timestamp);
                     
                     if (allQueue.length >= 2 && allQueue[0].userId === userId) {
                        // Ben en eskiyim ve bir rakip var. EÅŸleÅŸmeyi baÅŸlatÄ±yorum.
                        const potentialOpponentId = allQueue[1].userId;
                        await initiateMatch(potentialOpponentId);
                        return;
                     }
                }
            }
            
            // 3. Durum: BoÅŸta
            if (!myQueueDoc) {
                matchmakingStatus = 'idle';
            }
        }
        
        async function initiateMatch(potentialOpponentId) {
             if (!userId || !db) return;
             
             // Bir transaction iÃ§inde her iki kullanÄ±cÄ±nÄ±n kuyruk durumunu atomik olarak gÃ¼ncelle
             const myRef = doc(db, RACE_QUEUE_PATH, userId);
             const opponentRef = doc(db, RACE_QUEUE_PATH, potentialOpponentId);
             
             try {
                await runTransaction(db, async (transaction) => {
                    const myDoc = await transaction.get(myRef);
                    const opponentDoc = await transaction.get(opponentRef);

                    // EÅŸleÅŸmeyi sadece ikisi de 'in_queue' ise baÅŸlat
                    if (myDoc.exists() && myDoc.data().status === 'in_queue' && 
                        opponentDoc.exists() && opponentDoc.data().status === 'in_queue') {
                        
                        // Transaction'dan hemen sonra local state'i gÃ¼ncellemek kritik.
                        matchmakingStatus = 'in_match';
                        opponentId = potentialOpponentId;
                        
                        transaction.update(myRef, { status: 'in_match', opponentId: potentialOpponentId, matchStart: Date.now() });
                        transaction.update(opponentRef, { status: 'in_match', opponentId: userId, matchStart: Date.now() });
                        
                        // Local state'i gÃ¼ncelledikten sonra YarÄ±ÅŸmayÄ± baÅŸlat.
                        startCompetition(opponentId);
                        showMessage(`EÅŸleÅŸme bulundu! Rakibiniz: ${opponentId.substring(0, 8)}...`, 'success');
                    } else {
                        // Birisi Ã§oktan eÅŸleÅŸme buldu veya kuyruktan Ã§Ä±ktÄ±.
                        throw "EÅŸleÅŸme koÅŸullarÄ± ihlal edildi, yeniden denenecek.";
                    }
                });
            } catch (e) {
                console.log("EÅŸleÅŸme baÅŸlatma yarÄ±ÅŸÄ± kaybedildi veya hata oluÅŸtu:", e);
                // YarÄ±ÅŸ kaybedildiyse, dinleyici yeni durumu alacak ve UI gÃ¼ncellenecek.
            }
        }

        // --- YarÄ±ÅŸma UI GÃ¼ncelleme ---

        function updateCompetitionUI(queueUsers = []) {
            // queueUsers, kendimiz hariÃ§ kuyruktaki diÄŸer kullanÄ±cÄ±larÄ± iÃ§erir.
            const totalUsersInQueue = queueUsers.length + (matchmakingStatus === 'in_queue' ? 1 : 0);
            
            if (matchmakingStatus === 'idle') {
                toggleNavButtons(false); // ButonlarÄ± serbest bÄ±rak
                timerDisplay.textContent = `SÃ¼re: HazÄ±r`;
                competitionButton.textContent = "YARIÅMAYA BAÅLA";
                competitionButton.disabled = !IS_FIREBASE_ENABLED; // Firebase etkin deÄŸilse devre dÄ±ÅŸÄ±
                competitionButton.classList.replace('bg-gray-600', 'bg-green-600');
                competitionButton.classList.replace('bg-red-600', 'bg-green-600');
                if (IS_FIREBASE_ENABLED) {
                     competitionButton.classList.add('hover:bg-green-700');
                } else {
                     competitionButton.classList.replace('bg-green-600', 'bg-gray-600');
                     competitionButton.textContent = "Ã‡evrimiÃ§i DeÄŸil";
                }
            } else if (matchmakingStatus === 'in_queue') {
                toggleNavButtons(false); // Kuyrukta iken navigasyon serbest
                competitionActive = false;
                competitionButton.disabled = true;
                competitionButton.classList.replace('bg-green-600', 'bg-gray-600');
                competitionButton.classList.replace('bg-red-600', 'bg-gray-600');
                competitionButton.classList.remove('hover:bg-green-700');
                
                if (randomOpponentDisplayId) {
                    // 3+ KiÅŸi KuralÄ±: Oyuncu Bekleniyor
                    timerDisplay.textContent = `Oyuncu Bekleniyor (Rakip: ${randomOpponentDisplayId.substring(0, 8)}...)`;
                    competitionButton.textContent = `EÅŸleÅŸme AranÄ±yor... (${totalUsersInQueue} KiÅŸi Kuyrukta)`;
                } else {
                    // 2 KiÅŸi AranÄ±yor veya tek kiÅŸi var
                    timerDisplay.textContent = `EÅŸleÅŸme AranÄ±yor...`;
                    competitionButton.textContent = `EÅŸleÅŸme AranÄ±yor... (${totalUsersInQueue} KiÅŸi Kuyrukta)`;
                }
                
            } else if (matchmakingStatus === 'in_match') {
                if(competitionActive) {
                    toggleNavButtons(true); // YarÄ±ÅŸma aktif: ButonlarÄ± KÄ°LÄ°TLE
                } else {
                    // EÅŸleÅŸme bulundu ama yarÄ±ÅŸma henÃ¼z baÅŸlamadÄ±ysa veya bittiyse (endCompetition tarafÄ±ndan yÃ¶netilir)
                    toggleNavButtons(false); 
                }
                
                competitionButton.disabled = false;
                competitionButton.textContent = `TIKLA! Rakip: ${opponentId.substring(0, 8)}...`;
                competitionButton.classList.replace('bg-green-600', 'bg-red-600');
                competitionButton.classList.replace('bg-gray-600', 'bg-red-600');
                competitionButton.classList.add('hover:bg-red-700');
                // Timer, startCompetition iÃ§inde yÃ¶netiliyor
            }
        }
        
        function updateCompetitionDisplay(rank = -1, clicks = currentRaceClicks) {
            const rankText = rank > 0 ? ` (#${rank})` : '';
            myScoreDisplay.textContent = `Sizin TÄ±klamanÄ±z: ${formatNumber(clicks)} ${rankText}`;
        }
        
        // ------------------------------------------------------------------
        // YENÄ°: GÃ–RSEL GERÄ° BÄ°LDÄ°RÄ°M (POP-UP)
        // ------------------------------------------------------------------
        
        function createClickPopup(amount, x, y) {
            const popup = document.createElement('span');
            popup.textContent = `+${formatNumber(amount)}`;
            popup.classList.add('click-popup');
            
            const rect = clickButton.getBoundingClientRect();
            const posX = x - rect.left - (rect.width / 2) + Math.random() * 80 - 40;
            const posY = y - rect.top - (rect.height / 2) + Math.random() * 60 - 30;
            
            popup.style.left = `${posX}px`;
            popup.style.top = `${posY}px`;
            
            clickerArea.appendChild(popup);

            popup.addEventListener('animationend', () => {
                popup.remove();
            });
        }
        
        // ------------------------------------------------------------------
        // YENÄ°: YARIÅMA MANTIK
        // ------------------------------------------------------------------

        /**
         * YarÄ±ÅŸmanÄ±n sÃ¼resini takip eden geri sayÄ±m sayacÄ±
         */
        function startCompetitionTimer() {
            if (competitionTimer) clearInterval(competitionTimer);
            competitionStartTime = Date.now();
            
            // YarÄ±ÅŸma baÅŸladÄ±ÄŸÄ± anda navigasyon butonlarÄ±nÄ± kilitle
            toggleNavButtons(true); 

            competitionTimer = setInterval(() => {
                const elapsedTime = Math.floor((Date.now() - competitionStartTime) / 1000);
                const remainingTime = COMPETITION_DURATION_SECONDS - elapsedTime;

                if (remainingTime <= 0) {
                    endCompetition();
                } else {
                    timerDisplay.textContent = `SÃ¼re: ${remainingTime} saniye`;
                }
            }, 1000);
        }

        /**
         * YarÄ±ÅŸmayÄ± baÅŸlatÄ±r ve sayaÃ§ ile butonu ayarlar.
         */
        function startCompetition(opponentId) {
            competitionActive = true;
            
            // Skoru sÄ±fÄ±rla (Firestore listener zaten bunu yapmalÄ±, ama emin olmak iÃ§in)
            if (userId && db) {
                const userRaceDocRef = doc(db, RACE_SCORES_PATH, userId);
                setDoc(userRaceDocRef, { clicks: 0 }, { merge: true }).catch(e => console.error("Skor sÄ±fÄ±rlanamadÄ±:", e));
            }

            competitionButton.textContent = `TIKLA! Rakip: ${opponentId.substring(0, 8)}...`;
            competitionButton.disabled = false;
            competitionButton.classList.replace('bg-green-600', 'bg-red-600');
            competitionButton.classList.replace('bg-gray-600', 'bg-red-600');
            competitionButton.classList.add('hover:bg-red-700');
            
            startCompetitionTimer();
            showMessage(`DÃœELLO BAÅLADI! Rakibiniz: ${opponentId.substring(0, 8)}... TÄ±klamaya baÅŸlayÄ±n!`, 'success');
        }

        /**
         * YarÄ±ÅŸmayÄ± bitirir ve butonu kilitler.
         */
        async function endCompetition(isLeaving = false) {
            if (!competitionActive && !isLeaving) return; // Zaten bitmiÅŸse veya sadece gÃ¶rÃ¼nÃ¼mden ayrÄ±lÄ±yorsa

            competitionActive = false;
            clearInterval(competitionTimer);
            competitionTimer = null;
            
            // Navigasyon butonlarÄ±nÄ± serbest bÄ±rak
            toggleNavButtons(false);

            // Kuyruk durumunu sÄ±fÄ±rla (MaÃ§ bitti)
            // isLeaving true ise, leaveQueue iÃ§indeki Ã¶zel mesajÄ± gÃ¶stermemek iÃ§in parametre vermiyoruz.
            await leaveQueue(false); // Sadece state temizleme, Ã¶zel ayrÄ±lma mesajÄ± gÃ¶sterme
            
            if (!isLeaving) {
                timerDisplay.textContent = `SÃ¼re: BÄ°TTÄ°!`;
                competitionButton.textContent = "TEKRAR BAÅLA";
                competitionButton.disabled = false;
                competitionButton.classList.replace('bg-red-600', 'bg-green-600');
                competitionButton.classList.replace('bg-gray-600', 'bg-green-600');
                competitionButton.classList.add('hover:bg-green-700');
                showMessage("YarÄ±ÅŸma Sona Erdi! SonuÃ§lar Liderlik Tablosunda.", 'info');
            } else {
                updateCompetitionUI(); // GÃ¶rÃ¼nÃ¼mden ayrÄ±lma durumunda UI'Ä± temizle
            }
        }

        /**
         * YarÄ±ÅŸma butonuna tÄ±klama iÅŸleyicisi.
         */
        function handleCompetitionClick() {
            if (!IS_FIREBASE_ENABLED) {
                showMessage("Online YarÄ±ÅŸma, Firebase yapÄ±landÄ±rmasÄ± olmadan kullanÄ±lamaz.", 'error');
                return;
            }
            if (matchmakingStatus === 'idle') {
                // EÄŸer boÅŸta ise, kuyruÄŸa katÄ±l
                joinQueue();
            } else if (matchmakingStatus === 'in_match' && competitionActive) {
                // EÄŸer yarÄ±ÅŸma aktif ise, tÄ±klamayÄ± kaydet
                updateCompetitionScore();
            } else if (matchmakingStatus === 'in_match' && !competitionActive) {
                // MaÃ§ bitti ve tekrar baÅŸlatmak istiyor
                 endCompetition(true); // Ã–nceki match state'i temizle
                 joinQueue();
            }
        }
        
        // ------------------------------------------------------------------
        // OYUN MANTIK VE DÃ–NGÃœSÃœ (Normal Clicker)
        // ------------------------------------------------------------------
        
        function handleManualClick(e) {
            const actualClick = baseClickValue * rebirthMultiplier;
            coins += actualClick;
            
            if (e) {
                const rect = clickButton.getBoundingClientRect();
                const x = e.clientX - rect.left - (rect.width / 2) + Math.random() * 80 - 40;
                const y = e.clientY - rect.top - (rect.height / 2) + Math.random() * 60 - 30;
                
                createClickPopup(actualClick, x, y);
            }
            
            updateDisplay();
        }

        function handlePassiveIncome() {
            if (basePassiveRate > 0) {
                const actualPassive = basePassiveRate * rebirthMultiplier * passiveMultiplier;
                coins += actualPassive;
                updateDisplay();
            }
        }

        function updateDisplay() {
            const netClick = baseClickValue * rebirthMultiplier;
            const netPassive = basePassiveRate * rebirthMultiplier * passiveMultiplier;

            if (coinDisplay) coinDisplay.textContent = formatNumber(coins);
            if (rebirthDisplay) rebirthDisplay.textContent = formatNumber(rebirths);
            if (rbpDisplay) rbpDisplay.textContent = formatNumber(rebirthPoints); 
            if (clickValueDisplay) clickValueDisplay.textContent = `${formatNumber(netClick)} (x${rebirthMultiplier.toFixed(2)})`; 
            if (passiveRateDisplay) passiveRateDisplay.textContent = `${formatNumber(netPassive)} (x${(rebirthMultiplier * passiveMultiplier).toFixed(2)})`; 
            if (autoclickerDisplay) autoclickerDisplay.textContent = `${rbpAutoclickerLevel} / sn`;

            const requiredPassiveRate = 100;
            if (rebirthButton) { 
                 const canRebirth = netPassive >= requiredPassiveRate;
                 if (canRebirth) {
                     rebirthButton.classList.replace('bg-indigo-600', 'bg-purple-600');
                     rebirthButton.classList.add('hover:bg-purple-700');
                     rebirthButton.disabled = false;
                } else {
                     rebirthButton.classList.replace('bg-purple-600', 'bg-indigo-600');
                     rebirthButton.classList.remove('hover:bg-purple-700');
                     rebirthButton.disabled = true;
                }
            }
        }
        
        function buyItem(item) {
             if (item.level >= item.maxLevel) { showMessage(`${item.name} zaten maksimum seviyede!`); return; }
             if (coins >= item.cost) {
                 coins -= item.cost;
                 item.level += 1;
                 item.cost = Math.floor(item.initialCost * Math.pow(item.multiplier, item.level));
                 if (item.type === 'click') baseClickValue += item.value;
                 else if (item.type === 'passive') basePassiveRate += item.value;
                 
                 updateDisplay();
                 renderMarket(MARKET_ITEMS, marketItemsContainer, buyItem, coins, 'ğŸ’°');
                 saveGame();
             } else { showMessage("Yeterli paranÄ±z yok!"); }
        }

        function buyRebirthItem(item) {
            if (item.level >= item.maxLevel) { showMessage(`${item.name} zaten maksimum seviyede!`, 'info'); return; }
            if (rebirthPoints >= item.cost) {
                rebirthPoints -= item.cost;
                item.level += 1;
                item.cost = Math.floor(item.initialCost * Math.pow(item.multiplier, item.level));
                
                if (item.type === 'starting_coin') rbpStartingCoinBonus += item.value;
                else if (item.type === 'autoclick') { 
                    rbpAutoclickerLevel += item.value;
                    clearInterval(window.autoclickerInterval);
                    startAutoclickerLoop();
                }
                
                updateDisplay();
                renderMarket(REBIRTH_ITEMS, rebirthStoreItemsContainer, buyRebirthItem, rebirthPoints, 'âš›ï¸');
                saveGame();
            } else { showMessage("Yeterli RBP'niz yok!", 'error'); }
        }

        function performRebirth() {
            const netPassive = basePassiveRate * rebirthMultiplier * passiveMultiplier; 
            if (netPassive < 100) { showMessage(`Yeniden DoÄŸmak iÃ§in en az 100 Net SBK oranÄ±na ulaÅŸmalÄ±sÄ±nÄ±z!`, 'error'); return; }
            
            const rbpGained = Math.floor(netPassive / 100); 
            rebirthPoints += rbpGained;
            rebirths += 1;
            rebirthMultiplier = 1 + (rebirths * 0.20); 

            coins = rbpStartingCoinBonus; 
            baseClickValue = 1;
            basePassiveRate = 0;
            passiveMultiplier = 1; 

            MARKET_ITEMS.forEach(item => { item.level = 0; item.cost = item.initialCost; });

            showMessage(`Yeniden DoÄŸuÅŸ BaÅŸarÄ±lÄ±! KazanÄ±lan RBP: ${rbpGained}. KalÄ±cÄ± Ã‡arpanÄ±nÄ±z: x${rebirthMultiplier.toFixed(2)}`, 'success');
            updateDisplay();
            renderMarket(MARKET_ITEMS, marketItemsContainer, buyItem, coins, 'ğŸ’°');
            renderMarket(REBIRTH_ITEMS, rebirthStoreItemsContainer, buyRebirthItem, rebirthPoints, 'âš›ï¸'); 
            saveGame();
        }

        function renderMarket(items, container, buyFunction, currency, currencySymbol) {
            if (!container) return; 
            container.innerHTML = '';
            
            items.forEach(item => {
                const isAffordable = currency >= item.cost;
                const isMaxLevel = item.level >= item.maxLevel;
                
                let colorClass = currencySymbol === 'ğŸ’°' ? 'text-yellow-400' : 'text-purple-400';

                const cardHtml = `
                    <div id="item-${item.id}" class="p-4 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between transition duration-200 ${isMaxLevel ? 'bg-gray-600 opacity-50' : isAffordable ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-700 opacity-70 cursor-not-allowed'}">
                        <div class="mb-2 sm:mb-0">
                            <h3 class="text-xl font-bold ${colorClass}">${item.name} <span class="text-base text-gray-400">(Seviye: ${item.level} / ${item.maxLevel})</span></h3>
                            <p class="text-sm text-gray-300">${item.description}</p>
                        </div>
                        <button class="buy-btn w-full sm:w-auto px-4 py-2 mt-2 sm:mt-0 rounded-lg font-bold transition duration-200" 
                                data-item-id="${item.id}"
                                data-currency-type="${currencySymbol === 'ğŸ’°' ? 'coin' : 'rbp'}"
                                ${isMaxLevel || !isAffordable ? 'disabled' : ''}
                                style="${isMaxLevel ? 'background-color: #4b5563; color: #9ca3af;' : isAffordable ? 'background-color: #f59e0b; color: #1f2937;' : 'background-color: #9ca3af; color: #4b5563; cursor: not-allowed;'}">
                            ${isMaxLevel ? 'MAX SEVÄ°YE' : `${formatNumber(item.cost)} ${currencySymbol} AL`}
                        </button>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
            
            document.querySelectorAll(`#${container.id} .buy-btn`).forEach(button => {
                if (!button.disabled) {
                    button.addEventListener('click', (e) => {
                        const itemId = parseInt(e.currentTarget.getAttribute('data-item-id'));
                        const currencyType = e.currentTarget.getAttribute('data-currency-type');
                        
                        let item;
                        if (currencyType === 'coin') {
                            item = MARKET_ITEMS.find(i => i.id === itemId);
                            if (item) buyFunction(item);
                        } else if (currencyType === 'rbp') {
                            item = REBIRTH_ITEMS.find(i => i.id === itemId);
                            if (item) buyFunction(item);
                        }
                    });
                }
            });
        }
        
        function startPassiveIncomeLoop() {
             const intervalMs = 1000; 
             if (window.passiveInterval) clearInterval(window.passiveInterval);
             window.passiveInterval = setInterval(handlePassiveIncome, intervalMs);
        }
        
        function startAutoclickerLoop() {
            if (window.autoclickerInterval) clearInterval(window.autoclickerInterval);
            if (rbpAutoclickerLevel > 0) {
                window.autoclickerInterval = setInterval(() => {
                    for (let i = 0; i < rbpAutoclickerLevel; i++) {
                        handleManualClick(null); 
                    }
                }, 1000);
            }
        }

        // ------------------------------------------------------------------
        // KALICI KAYIT (LOCAL STORAGE)
        // ------------------------------------------------------------------
        
        function saveGame() {
            const gameState = {
                coins, baseClickValue, basePassiveRate, rebirths, rebirthMultiplier, passiveMultiplier, rebirthPoints,
                rbpStartingCoinBonus, rbpPassiveSpeedBonus, rbpAutoclickerLevel,
                lastSaveTime: Date.now(),
                marketItems: MARKET_ITEMS.map(item => ({ id: item.id, level: item.level, cost: item.cost })),
                rebirthStoreItems: REBIRTH_ITEMS.map(item => ({ id: item.id, level: item.level, cost: item.cost })), 
            };
            localStorage.setItem('clickerGameSave', JSON.stringify(gameState));
        }

        function loadGame() {
            const savedState = localStorage.getItem('clickerGameSave');
            if (savedState) {
                const gameState = JSON.parse(savedState);
                
                coins = gameState.coins || 0;
                baseClickValue = gameState.baseClickValue || 1;
                basePassiveRate = gameState.basePassiveRate || 0;
                rebirths = gameState.rebirths || 0;
                rebirthMultiplier = gameState.rebirthMultiplier || 1;
                passiveMultiplier = gameState.passiveMultiplier || 1;
                rebirthPoints = gameState.rebirthPoints || 0; 
                rbpStartingCoinBonus = gameState.rbpStartingCoinBonus || 0; 
                rbpPassiveSpeedBonus = gameState.rbpPassiveSpeedBonus || 1; 
                rbpAutoclickerLevel = gameState.rbpAutoclickerLevel || 0; 
                lastSaveTime = gameState.lastSaveTime || Date.now(); 

                if (gameState.marketItems) {
                    gameState.marketItems.forEach(savedItem => {
                        const item = MARKET_ITEMS.find(i => i.id === savedItem.id);
                        if (item) {
                            item.level = savedItem.level;
                            item.cost = savedItem.cost;
                        }
                    });
                }
                
                if (gameState.rebirthStoreItems) {
                    gameState.rebirthStoreItems.forEach(savedItem => {
                        const item = REBIRTH_ITEMS.find(i => i.id === savedItem.id);
                        if (item) {
                            item.level = savedItem.level;
                            item.cost = savedItem.cost;
                        }
                    });
                }
                
                 passiveMultiplier = 1;
                 MARKET_ITEMS.filter(i => i.type === 'multiplier').forEach(i => {
                    passiveMultiplier *= Math.pow(i.value, i.level);
                 });


                const timePassedMs = Date.now() - lastSaveTime;
                const timePassedSeconds = Math.floor(timePassedMs / 1000);
                
                const effectiveOfflineTime = Math.min(timePassedSeconds, MAX_OFFLINE_TIME_SECONDS);
                
                const netPassiveRate = basePassiveRate * rebirthMultiplier * passiveMultiplier;
                
                if (effectiveOfflineTime > 0 && netPassiveRate > 0) {
                    const offlineGains = netPassiveRate * effectiveOfflineTime;
                    coins += offlineGains;
                    
                    const hours = Math.floor(effectiveOfflineTime / 3600);
                    const minutes = Math.floor((effectiveOfflineTime % 3600) / 60);
                    
                    let timeString = '';
                    if (hours > 0) timeString += `${hours} saat `;
                    if (minutes > 0) timeString += `${minutes} dakika`;
                    if (timeString === '') timeString = `${effectiveOfflineTime} saniye`;
                    
                    showMessage(`HoÅŸ geldiniz! ${timeString} boyunca Ã§evrimdÄ±ÅŸÄ±ydÄ±nÄ±z ve ${formatNumber(offlineGains)} ğŸ’° kazandÄ±nÄ±z!`, 'offline');
                } else if (effectiveOfflineTime > 0) {
                    showMessage("HoÅŸ geldiniz! Ã‡evrimdÄ±ÅŸÄ±ydÄ±nÄ±z ancak pasif geliriniz 0 olduÄŸu iÃ§in kazanÃ§ elde edemediniz.", 'info');
                } else {
                    showMessage("Oyun YÃ¼klendi!", 'success');
                }
                
                lastSaveTime = Date.now();
                saveGame();
                
                updateDisplay();
                renderMarket(MARKET_ITEMS, marketItemsContainer, buyItem, coins, 'ğŸ’°');
                renderMarket(REBIRTH_ITEMS, rebirthStoreItemsContainer, buyRebirthItem, rebirthPoints, 'âš›ï¸');
                return true;
            }
            return false;
        }

        // ------------------------------------------------------------------
        // OYUN BAÅLATMA
        // ------------------------------------------------------------------

        function initializeGame() {
            initializeFirebase(); 
            loadGame();

            if (clickButton) clickButton.addEventListener('click', handleManualClick);
            if (rebirthButton) rebirthButton.addEventListener('click', performRebirth);
            if (competitionButton) competitionButton.addEventListener('click', handleCompetitionClick);
            
            if (navClicker) navClicker.addEventListener('click', () => switchView('clickerView'));
            if (navMarket) navMarket.addEventListener('click', () => switchView('marketView'));
            if (navRebirthStore) navRebirthStore.addEventListener('click', () => switchView('rebirthStoreView'));
            if (navCompetition) navCompetition.addEventListener('click', () => switchView('competitionView'));

            startPassiveIncomeLoop();
            startAutoclickerLoop();
            
            setInterval(saveGame, 5000);

            updateDisplay();
            switchView('clickerView'); 
        }

        document.addEventListener('DOMContentLoaded', initializeGame);
        
    </script>
</body>
</html>
